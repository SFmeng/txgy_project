# 防腐保温智慧平台后端开发文档

## 1. 项目概述

### 1.1 技术栈
- **Python版本**: 3.12.3
- **Web框架**: Django 5.2.5
- **API框架**: Django REST Framework 3.15+
- **数据库**: MySQL 8.0+ (主数据库)
- **缓存**: Redis 6.0+
- **搜索引擎**: Elasticsearch 8.0+
- **任务队列**: Celery 5.3+
- **消息代理**: Redis/RabbitMQ

### 1.2 项目结构
```
txgy_api/
├── config/                    # 项目配置
│   ├── settings/             # 分环境配置
│   │   ├── __init__.py
│   │   ├── base.py          # 基础配置
│   │   ├── development.py   # 开发环境
│   │   ├── production.py    # 生产环境
│   │   └── testing.py       # 测试环境
│   ├── urls.py              # 主路由配置
│   └── wsgi.py              # WSGI配置
├── apps/                     # 应用模块
│   ├── authentication/      # 用户认证模块
│   ├── info_publish/        # 信息发布模块
│   ├── search_match/        # 搜索匹配模块
│   ├── communication/       # 沟通交流模块
│   ├── resources/           # 资源管理模块
│   ├── business/            # 商务服务模块
│   ├── tech_service/        # 技术服务模块
│   ├── bidding/             # 招投标模块
│   ├── data_center/         # 数据中心模块
│   └── common/              # 公共模块
├── utils/                    # 工具函数
├── middleware/               # 中间件
├── requirements/             # 依赖文件
│   ├── base.txt
│   ├── development.txt
│   └── production.txt
├── manage.py
├── celery_app.py            # Celery配置
└── README.md
```

## 2. 环境配置

### 2.1 虚拟环境创建
```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境 (Windows)
venv\Scripts\activate

# 激活虚拟环境 (Linux/Mac)
source venv/bin/activate

# 安装依赖
pip install -r requirements/development.txt
```

### 2.2 核心依赖 (requirements/base.txt)
```
Django==5.2.5
djangorestframework==3.15.2
django-cors-headers==4.3.1
django-filter==23.3
drf-yasg==1.21.7
PyMySQL==1.1.0
redis==5.0.1
elasticsearch==8.10.0
celery==5.3.4
django-celery-beat==2.5.0
Pillow==10.0.1
python-decouple==3.8
cryptography==41.0.7
PyJWT==2.8.0
requests==2.31.0
```

### 2.3 Django配置 (config/settings/base.py)
```python
import os
from pathlib import Path
from decouple import config

BASE_DIR = Path(__file__).resolve().parent.parent.parent

# 安全配置
SECRET_KEY = config('SECRET_KEY')
DEBUG = config('DEBUG', default=False, cast=bool)
ALLOWED_HOSTS = config('ALLOWED_HOSTS', default='').split(',')

# 应用配置
DJANGO_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]

THIRD_PARTY_APPS = [
    'rest_framework',
    'corsheaders',
    'django_filters',
    'drf_yasg',
    'django_celery_beat',
]

LOCAL_APPS = [
    'apps.authentication',
    'apps.info_publish',
    'apps.search_match',
    'apps.communication',
    'apps.resources',
    'apps.business',
    'apps.tech_service',
    'apps.bidding',
    'apps.data_center',
    'apps.common',
]

INSTALLED_APPS = DJANGO_APPS + THIRD_PARTY_APPS + LOCAL_APPS

# 中间件配置
MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'middleware.request_logging.RequestLoggingMiddleware',
]

ROOT_URLCONF = 'config.urls'

# 模板配置
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

# 数据库配置
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': config('DB_NAME'),
        'USER': config('DB_USER'),
        'PASSWORD': config('DB_PASSWORD'),
        'HOST': config('DB_HOST', default='localhost'),
        'PORT': config('DB_PORT', default='3306'),
        'OPTIONS': {
            'charset': 'utf8mb4',
            'init_command': "SET sql_mode='STRICT_TRANS_TABLES'",
        }
    }
}

# Redis配置
REDIS_URL = config('REDIS_URL', default='redis://localhost:6379/0')

CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': REDIS_URL,
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        }
    }
}

# Elasticsearch配置
ELASTICSEARCH_DSL = {
    'default': {
        'hosts': config('ELASTICSEARCH_URL', default='localhost:9200')
    },
}

# REST Framework配置
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework_simplejwt.authentication.JWTAuthentication',
    ],
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.IsAuthenticated',
    ],
    'DEFAULT_RENDERER_CLASSES': [
        'rest_framework.renderers.JSONRenderer',
    ],
    'DEFAULT_PARSER_CLASSES': [
        'rest_framework.parsers.JSONParser',
        'rest_framework.parsers.MultiPartParser',
    ],
    'DEFAULT_PAGINATION_CLASS': 'utils.pagination.CustomPageNumberPagination',
    'PAGE_SIZE': 20,
    'DEFAULT_FILTER_BACKENDS': [
        'django_filters.rest_framework.DjangoFilterBackend',
        'rest_framework.filters.SearchFilter',
        'rest_framework.filters.OrderingFilter',
    ],
}

# JWT配置
from datetime import timedelta
SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(hours=24),
    'REFRESH_TOKEN_LIFETIME': timedelta(days=7),
    'ROTATE_REFRESH_TOKENS': True,
    'BLACKLIST_AFTER_ROTATION': True,
}

# 国际化配置
LANGUAGE_CODE = 'zh-hans'
TIME_ZONE = 'Asia/Shanghai'
USE_I18N = True
USE_TZ = True

# 静态文件配置
STATIC_URL = '/static/'
STATIC_ROOT = BASE_DIR / 'staticfiles'
STATICFILES_DIRS = [BASE_DIR / 'static']

# 媒体文件配置
MEDIA_URL = '/media/'
MEDIA_ROOT = BASE_DIR / 'media'

# 文件上传配置
FILE_UPLOAD_MAX_MEMORY_SIZE = 20 * 1024 * 1024  # 20MB
DATA_UPLOAD_MAX_MEMORY_SIZE = 20 * 1024 * 1024  # 20MB

# 日志配置
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': BASE_DIR / 'logs' / 'django.log',
            'formatter': 'verbose',
        },
        'console': {
            'level': 'DEBUG',
            'class': 'logging.StreamHandler',
            'formatter': 'verbose',
        },
    },
    'root': {
        'handlers': ['console', 'file'],
        'level': 'INFO',
    },
}

# Celery配置
CELERY_BROKER_URL = REDIS_URL
CELERY_RESULT_BACKEND = REDIS_URL
CELERY_ACCEPT_CONTENT = ['json']
CELERY_TASK_SERIALIZER = 'json'
CELERY_RESULT_SERIALIZER = 'json'
CELERY_TIMEZONE = TIME_ZONE
```

## 3. 核心模块开发

### 3.1 用户认证模块 (apps/authentication/)

#### 3.1.1 用户模型 (models.py)
```python
from django.contrib.auth.models import AbstractUser
from django.db import models
import uuid

class User(AbstractUser):
    """用户基础模型"""
    USER_TYPE_CHOICES = [
        ('enterprise', '企业用户'),
        ('individual', '个人用户'),
    ]
    
    STATUS_CHOICES = [
        ('active', '正常'),
        ('inactive', '未激活'),
        ('pending_review', '待审核'),
        ('banned', '已封禁'),
    ]
    
    user_id = models.CharField(max_length=32, unique=True, editable=False)
    phone = models.CharField(max_length=11, unique=True, null=True, blank=True)
    user_type = models.CharField(max_length=20, choices=USER_TYPE_CHOICES)
    real_name = models.CharField(max_length=50, null=True, blank=True)
    avatar = models.ImageField(upload_to='avatars/', null=True, blank=True)
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='pending_review')
    last_login_ip = models.GenericIPAddressField(null=True, blank=True)
    
    class Meta:
        db_table = 'tx_users'
        verbose_name = '用户'
        verbose_name_plural = '用户'
    
    def save(self, *args, **kwargs):
        if not self.user_id:
            self.user_id = self.generate_user_id()
        super().save(*args, **kwargs)
    
    def generate_user_id(self):
        """生成用户ID"""
        from datetime import datetime
        timestamp = datetime.now().strftime('%Y%m')
        # 获取当月最大序号
        last_user = User.objects.filter(
            user_id__startswith=f'USR-{timestamp}'
        ).order_by('-user_id').first()
        
        if last_user:
            last_seq = int(last_user.user_id.split('-')[-1])
            new_seq = last_seq + 1
        else:
            new_seq = 1
            
        return f'USR-{timestamp}-{new_seq:03d}'

class Enterprise(models.Model):
    """企业信息模型"""
    COMPANY_TYPE_CHOICES = [
        ('manufacturer', '生产制造企业'),
        ('constructor', '施工安装企业'),
        ('owner', '工程甲方企业'),
        ('supplier', '供应商企业'),
    ]
    
    CERTIFICATION_STATUS_CHOICES = [
        ('verified', '已认证'),
        ('pending', '待认证'),
        ('rejected', '认证失败'),
    ]
    
    RATING_CHOICES = [
        ('1star', '一星'),
        ('2star', '二星'),
        ('3star', '三星'),
        ('4star', '四星'),
        ('5star', '五星'),
    ]
    
    enterprise_id = models.CharField(max_length=32, primary_key=True, editable=False)
    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name='enterprise')
    company_name = models.CharField(max_length=100)
    company_type = models.CharField(max_length=20, choices=COMPANY_TYPE_CHOICES)
    business_license = models.CharField(max_length=50, unique=True, null=True, blank=True)
    contact_person = models.CharField(max_length=50, null=True, blank=True)
    contact_phone = models.CharField(max_length=11, null=True, blank=True)
    contact_email = models.EmailField(null=True, blank=True)
    address = models.CharField(max_length=200, null=True, blank=True)
    province = models.CharField(max_length=20, null=True, blank=True)
    city = models.CharField(max_length=20, null=True, blank=True)
    district = models.CharField(max_length=20, null=True, blank=True)
    business_scope = models.TextField(null=True, blank=True)
    registered_capital = models.DecimalField(max_digits=15, decimal_places=2, null=True, blank=True)
    established_year = models.PositiveIntegerField(null=True, blank=True)
    annual_output = models.CharField(max_length=100, null=True, blank=True)
    employee_count = models.PositiveIntegerField(null=True, blank=True)
    certification_status = models.CharField(max_length=20, choices=CERTIFICATION_STATUS_CHOICES, default='pending')
    rating = models.CharField(max_length=10, choices=RATING_CHOICES, null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'tx_enterprises'
        verbose_name = '企业信息'
        verbose_name_plural = '企业信息'
    
    def save(self, *args, **kwargs):
        if not self.enterprise_id:
            self.enterprise_id = self.generate_enterprise_id()
        super().save(*args, **kwargs)
    
    def generate_enterprise_id(self):
        """生成企业ID"""
        from datetime import datetime
        timestamp = datetime.now().strftime('%Y%m')
        last_enterprise = Enterprise.objects.filter(
            enterprise_id__startswith=f'ENT-{timestamp}'
        ).order_by('-enterprise_id').first()
        
        if last_enterprise:
            last_seq = int(last_enterprise.enterprise_id.split('-')[-1])
            new_seq = last_seq + 1
        else:
            new_seq = 1
            
        return f'ENT-{timestamp}-{new_seq:03d}'
```

#### 3.1.2 认证视图 (views.py)
```python
from rest_framework import status
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import AllowAny, IsAuthenticated
from rest_framework.response import Response
from rest_framework_simplejwt.tokens import RefreshToken
from django.contrib.auth import authenticate
from django.core.cache import cache
from .models import User, Enterprise
from .serializers import UserRegistrationSerializer, UserProfileSerializer
from utils.response import success_response, error_response
from utils.sms import send_verification_code

@api_view(['POST'])
@permission_classes([AllowAny])
def register(request):
    """用户注册"""
    serializer = UserRegistrationSerializer(data=request.data)
    if serializer.is_valid():
        # 验证短信验证码
        phone = serializer.validated_data['phone']
        verification_code = serializer.validated_data['verification_code']
        
        cached_code = cache.get(f'sms_code_{phone}')
        if not cached_code or cached_code != verification_code:
            return error_response('验证码错误或已过期', code=40002)
        
        # 创建用户
        user = serializer.save()
        
        # 创建企业信息（如果是企业用户）
        if user.user_type == 'enterprise':
            enterprise_data = serializer.validated_data.get('enterprise_info', {})
            Enterprise.objects.create(user=user, **enterprise_data)
        
        # 清除验证码
        cache.delete(f'sms_code_{phone}')
        
        return success_response({
            'user_id': user.user_id,
            'username': user.username,
            'user_type': user.user_type,
            'status': user.status
        }, message='注册成功')
    
    return error_response('注册失败', errors=serializer.errors, code=40002)

@api_view(['POST'])
@permission_classes([AllowAny])
def login(request):
    """用户登录"""
    username = request.data.get('username')
    password = request.data.get('password')
    login_type = request.data.get('login_type', 'password')
    
    if not username or not password:
        return error_response('用户名和密码不能为空', code=40001)
    
    # 支持用户名或手机号登录
    user = authenticate(request, username=username, password=password)
    if not user:
        # 尝试手机号登录
        try:
            user_obj = User.objects.get(phone=username)
            user = authenticate(request, username=user_obj.username, password=password)
        except User.DoesNotExist:
            pass
    
    if user and user.is_active:
        if user.status == 'banned':
            return error_response('账号已被封禁', code=40102)
        elif user.status == 'pending_review':
            return error_response('账号待审核，请耐心等待', code=40102)
        
        # 生成JWT Token
        refresh = RefreshToken.for_user(user)
        access_token = refresh.access_token
        
        # 更新登录信息
        user.last_login_ip = get_client_ip(request)
        user.save(update_fields=['last_login_ip'])
        
        # 获取用户权限
        permissions = get_user_permissions(user)
        
        # 构建用户信息
        user_info = {
            'user_id': user.user_id,
            'username': user.username,
            'user_type': user.user_type,
            'permissions': permissions
        }
        
        # 如果是企业用户，添加企业信息
        if user.user_type == 'enterprise' and hasattr(user, 'enterprise'):
            user_info['enterprise_info'] = {
                'company_name': user.enterprise.company_name,
                'company_type': user.enterprise.company_type,
                'enterprise_id': user.enterprise.enterprise_id
            }
        
        return success_response({
            'access_token': str(access_token),
            'refresh_token': str(refresh),
            'expires_in': 3600,
            'user_info': user_info
        }, message='登录成功')
    
    return error_response('用户名或密码错误', code=40101)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def logout(request):
    """用户登出"""
    try:
        refresh_token = request.data.get('refresh_token')
        if refresh_token:
            token = RefreshToken(refresh_token)
            token.blacklist()
        return success_response(message='登出成功')
    except Exception:
        return success_response(message='登出成功')

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def profile(request):
    """获取用户信息"""
    serializer = UserProfileSerializer(request.user)
    return success_response(serializer.data)

def get_client_ip(request):
    """获取客户端IP地址"""
    x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
    if x_forwarded_for:
        ip = x_forwarded_for.split(',')[0]
    else:
        ip = request.META.get('REMOTE_ADDR')
    return ip

def get_user_permissions(user):
    """获取用户权限列表"""
    # 根据用户类型和企业类型返回权限
    permissions = ['basic_access']
    
    if user.user_type == 'enterprise':
        permissions.extend(['info_publish', 'search_match', 'communication'])
        
        if hasattr(user, 'enterprise'):
            company_type = user.enterprise.company_type
            if company_type == 'supplier':
                permissions.extend(['inventory_manage', 'quotation_manage'])
            elif company_type in ['manufacturer', 'constructor']:
                permissions.extend(['demand_publish', 'bidding_participate'])
            elif company_type == 'owner':
                permissions.extend(['tender_publish', 'project_manage'])
    
    elif user.user_type == 'individual':
        permissions.extend(['job_search', 'tech_consultation'])
    
    return permissions
```
