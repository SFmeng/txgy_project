# 防腐保温智慧平台部署文档

## 1. 部署架构概述

### 1.1 系统架构图
```
                    ┌─────────────────┐
                    │   Load Balancer │
                    │    (Nginx)      │
                    └─────────┬───────┘
                              │
                    ┌─────────┴───────┐
                    │   Web Server    │
                    │   (Frontend)    │
                    └─────────┬───────┘
                              │
                    ┌─────────┴───────┐
                    │  API Server     │
                    │  (Django)       │
                    └─────────┬───────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
┌───────┴────────┐  ┌─────────┴────────┐  ┌─────────┴────────┐
│     MySQL      │  │      Redis       │  │  Elasticsearch   │
│  (主数据库)     │  │     (缓存)       │  │    (搜索)        │
└────────────────┘  └──────────────────┘  └──────────────────┘
```

### 1.2 服务器配置要求

#### 1.2.1 最小配置（开发/测试环境）
- **CPU**: 4核
- **内存**: 8GB
- **存储**: 100GB SSD
- **网络**: 10Mbps

#### 1.2.2 推荐配置（生产环境）
- **CPU**: 8核
- **内存**: 16GB
- **存储**: 500GB SSD
- **网络**: 100Mbps

#### 1.2.3 高可用配置（大规模生产环境）
- **Web服务器**: 2台 (4核8GB)
- **API服务器**: 3台 (8核16GB)
- **数据库服务器**: 1主2从 (16核32GB)
- **Redis集群**: 3台 (4核8GB)
- **Elasticsearch集群**: 3台 (8核16GB)

## 2. 环境准备

### 2.1 操作系统要求
- **推荐**: Ubuntu 22.04 LTS / CentOS 8+ / Rocky Linux 8+
- **最低**: Ubuntu 20.04 LTS / CentOS 7+

### 2.2 基础软件安装

#### 2.2.1 Python环境
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install python3.12 python3.12-venv python3.12-dev python3-pip

# CentOS/RHEL
sudo dnf install python3.12 python3.12-devel python3-pip
```

#### 2.2.2 Node.js环境
```bash
# 使用NodeSource仓库安装Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 或使用nvm安装
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install 18
nvm use 18
```

#### 2.2.3 MySQL 8.0安装
```bash
# Ubuntu
sudo apt install mysql-server-8.0

# 安全配置
sudo mysql_secure_installation

# 创建数据库和用户
mysql -u root -p
CREATE DATABASE txgy_platform CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'txgy_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON txgy_platform.* TO 'txgy_user'@'localhost';
FLUSH PRIVILEGES;
```

#### 2.2.4 Redis安装
```bash
# Ubuntu
sudo apt install redis-server

# 启动Redis服务
sudo systemctl start redis-server
sudo systemctl enable redis-server

# 配置Redis
sudo nano /etc/redis/redis.conf
# 修改以下配置：
# bind 127.0.0.1
# requirepass your_redis_password
# maxmemory 2gb
# maxmemory-policy allkeys-lru

# 重启Redis
sudo systemctl restart redis-server
```

#### 2.2.5 Elasticsearch安装
```bash
# 添加Elasticsearch仓库
wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -
echo "deb https://artifacts.elastic.co/packages/8.x/apt stable main" | sudo tee /etc/apt/sources.list.d/elastic-8.x.list

# 安装Elasticsearch
sudo apt update
sudo apt install elasticsearch

# 配置Elasticsearch
sudo nano /etc/elasticsearch/elasticsearch.yml
# 修改以下配置：
# cluster.name: txgy-cluster
# node.name: node-1
# network.host: localhost
# http.port: 9200
# discovery.type: single-node

# 启动Elasticsearch
sudo systemctl start elasticsearch
sudo systemctl enable elasticsearch
```

#### 2.2.6 Nginx安装
```bash
# Ubuntu
sudo apt install nginx

# 启动Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

## 3. 后端部署

### 3.1 代码部署
```bash
# 创建部署目录
sudo mkdir -p /opt/txgy_platform
sudo chown $USER:$USER /opt/txgy_platform

# 克隆代码（或上传代码包）
cd /opt/txgy_platform
git clone <repository_url> .

# 创建虚拟环境
python3.12 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements/production.txt
```

### 3.2 环境变量配置
```bash
# 创建环境变量文件
nano /opt/txgy_platform/.env
```

```env
# Django配置
SECRET_KEY=your_very_secret_key_here
DEBUG=False
ALLOWED_HOSTS=your-domain.com,www.your-domain.com,localhost

# 数据库配置
DB_NAME=txgy_platform
DB_USER=txgy_user
DB_PASSWORD=your_db_password
DB_HOST=localhost
DB_PORT=3306

# Redis配置
REDIS_URL=redis://:your_redis_password@localhost:6379/0

# Elasticsearch配置
ELASTICSEARCH_URL=localhost:9200

# 文件存储配置
MEDIA_ROOT=/opt/txgy_platform/media
STATIC_ROOT=/opt/txgy_platform/staticfiles

# 邮件配置
EMAIL_HOST=smtp.example.com
EMAIL_PORT=587
EMAIL_HOST_USER=noreply@your-domain.com
EMAIL_HOST_PASSWORD=your_email_password
EMAIL_USE_TLS=True

# 短信配置
SMS_ACCESS_KEY=your_sms_access_key
SMS_SECRET_KEY=your_sms_secret_key

# 文件上传配置
MAX_FILE_SIZE=20971520
ALLOWED_FILE_TYPES=jpg,jpeg,png,gif,pdf,doc,docx,xls,xlsx,mp4,avi

# 安全配置
CORS_ALLOWED_ORIGINS=https://your-domain.com,https://www.your-domain.com
CSRF_TRUSTED_ORIGINS=https://your-domain.com,https://www.your-domain.com
```

### 3.3 数据库迁移
```bash
# 激活虚拟环境
source /opt/txgy_platform/venv/bin/activate

# 进入项目目录
cd /opt/txgy_platform

# 执行数据库迁移
python manage.py makemigrations
python manage.py migrate

# 创建超级用户
python manage.py createsuperuser

# 收集静态文件
python manage.py collectstatic --noinput

# 加载初始数据
python manage.py loaddata fixtures/initial_data.json
```

### 3.4 Gunicorn配置
```bash
# 安装Gunicorn
pip install gunicorn

# 创建Gunicorn配置文件
nano /opt/txgy_platform/gunicorn.conf.py
```

```python
# gunicorn.conf.py
import multiprocessing

bind = "127.0.0.1:8000"
workers = multiprocessing.cpu_count() * 2 + 1
worker_class = "sync"
worker_connections = 1000
max_requests = 1000
max_requests_jitter = 100
timeout = 30
keepalive = 2
preload_app = True
daemon = False
user = "www-data"
group = "www-data"
pidfile = "/opt/txgy_platform/gunicorn.pid"
accesslog = "/opt/txgy_platform/logs/gunicorn_access.log"
errorlog = "/opt/txgy_platform/logs/gunicorn_error.log"
loglevel = "info"
```

### 3.5 Systemd服务配置
```bash
# 创建systemd服务文件
sudo nano /etc/systemd/system/txgy-api.service
```

```ini
[Unit]
Description=TXGY Platform API Server
After=network.target mysql.service redis.service

[Service]
Type=notify
User=www-data
Group=www-data
WorkingDirectory=/opt/txgy_platform
Environment=PATH=/opt/txgy_platform/venv/bin
ExecStart=/opt/txgy_platform/venv/bin/gunicorn config.wsgi:application -c gunicorn.conf.py
ExecReload=/bin/kill -s HUP $MAINPID
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
```

```bash
# 启动服务
sudo systemctl daemon-reload
sudo systemctl start txgy-api
sudo systemctl enable txgy-api
```

### 3.6 Celery配置
```bash
# 创建Celery worker服务
sudo nano /etc/systemd/system/txgy-celery.service
```

```ini
[Unit]
Description=TXGY Platform Celery Worker
After=network.target redis.service

[Service]
Type=forking
User=www-data
Group=www-data
WorkingDirectory=/opt/txgy_platform
Environment=PATH=/opt/txgy_platform/venv/bin
ExecStart=/opt/txgy_platform/venv/bin/celery -A config worker -D --loglevel=info --logfile=/opt/txgy_platform/logs/celery.log
ExecStop=/opt/txgy_platform/venv/bin/celery -A config control shutdown
Restart=always

[Install]
WantedBy=multi-user.target
```

```bash
# 创建Celery beat服务
sudo nano /etc/systemd/system/txgy-celery-beat.service
```

```ini
[Unit]
Description=TXGY Platform Celery Beat
After=network.target redis.service

[Service]
Type=forking
User=www-data
Group=www-data
WorkingDirectory=/opt/txgy_platform
Environment=PATH=/opt/txgy_platform/venv/bin
ExecStart=/opt/txgy_platform/venv/bin/celery -A config beat -D --loglevel=info --logfile=/opt/txgy_platform/logs/celery-beat.log
Restart=always

[Install]
WantedBy=multi-user.target
```

## 4. 前端部署

### 4.1 构建前端项目
```bash
# 进入前端项目目录
cd /opt/txgy_platform/txgy_frontend

# 安装依赖
npm install

# 构建生产版本
npm run build

# 构建完成后，dist目录包含所有静态文件
```

### 4.2 Nginx配置
```bash
# 创建Nginx配置文件
sudo nano /etc/nginx/sites-available/txgy-platform
```

```nginx
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;
    
    # SSL证书配置
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # 前端静态文件
    location / {
        root /opt/txgy_platform/txgy_frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # 静态资源缓存
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # API接口代理
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # 媒体文件
    location /media/ {
        alias /opt/txgy_platform/media/;
        expires 30d;
        add_header Cache-Control "public";
    }
    
    # 静态文件
    location /static/ {
        alias /opt/txgy_platform/staticfiles/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # 文件上传大小限制
    client_max_body_size 20M;
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
}
```

```bash
# 启用站点配置
sudo ln -s /etc/nginx/sites-available/txgy-platform /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## 5. 数据库优化配置

### 5.1 MySQL优化配置
```bash
# 编辑MySQL配置文件
sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf
```

```ini
[mysqld]
# 基础配置
port = 3306
socket = /var/run/mysqld/mysqld.sock
datadir = /var/lib/mysql
log-error = /var/log/mysql/error.log

# 字符集配置
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# 内存配置
innodb_buffer_pool_size = 4G
innodb_log_file_size = 256M
innodb_log_buffer_size = 16M
key_buffer_size = 256M
max_connections = 500
thread_cache_size = 50

# 查询缓存
query_cache_type = 1
query_cache_size = 256M

# 慢查询日志
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2

# 二进制日志
log-bin = mysql-bin
binlog_format = ROW
expire_logs_days = 7

# InnoDB配置
innodb_file_per_table = 1
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT
```

### 5.2 Redis优化配置
```bash
# 编辑Redis配置文件
sudo nano /etc/redis/redis.conf
```

```conf
# 内存配置
maxmemory 2gb
maxmemory-policy allkeys-lru

# 持久化配置
save 900 1
save 300 10
save 60 10000

# 网络配置
bind 127.0.0.1
port 6379
timeout 300
tcp-keepalive 300

# 安全配置
requirepass your_redis_password

# 日志配置
loglevel notice
logfile /var/log/redis/redis-server.log
```

## 6. 监控与日志

### 6.1 日志配置

#### 6.1.1 应用日志目录创建
```bash
# 创建日志目录
sudo mkdir -p /opt/txgy_platform/logs
sudo chown www-data:www-data /opt/txgy_platform/logs
```

#### 6.1.2 日志轮转配置
```bash
# 创建logrotate配置
sudo nano /etc/logrotate.d/txgy-platform
```

```
/opt/txgy_platform/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
    postrotate
        systemctl reload txgy-api
    endscript
}
```

### 6.2 系统监控

#### 6.2.1 服务状态监控脚本
```bash
# 创建监控脚本
nano /opt/txgy_platform/scripts/health_check.sh
```

```bash
#!/bin/bash

# 检查API服务状态
check_api() {
    response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/api/v1/health/)
    if [ $response -eq 200 ]; then
        echo "API服务正常"
        return 0
    else
        echo "API服务异常，状态码: $response"
        return 1
    fi
}

# 检查数据库连接
check_database() {
    mysql -u txgy_user -p$DB_PASSWORD -e "SELECT 1" txgy_platform > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo "数据库连接正常"
        return 0
    else
        echo "数据库连接异常"
        return 1
    fi
}

# 检查Redis连接
check_redis() {
    redis-cli -a $REDIS_PASSWORD ping > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo "Redis连接正常"
        return 0
    else
        echo "Redis连接异常"
        return 1
    fi
}

# 检查Elasticsearch
check_elasticsearch() {
    response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:9200/_cluster/health)
    if [ $response -eq 200 ]; then
        echo "Elasticsearch正常"
        return 0
    else
        echo "Elasticsearch异常"
        return 1
    fi
}

# 执行所有检查
echo "开始健康检查..."
check_api
check_database  
check_redis
check_elasticsearch
echo "健康检查完成"
```

```bash
# 设置执行权限
chmod +x /opt/txgy_platform/scripts/health_check.sh

# 添加到crontab，每5分钟检查一次
crontab -e
*/5 * * * * /opt/txgy_platform/scripts/health_check.sh >> /opt/txgy_platform/logs/health_check.log 2>&1
```

## 7. 安全配置

### 7.1 防火墙配置
```bash
# 启用UFW防火墙
sudo ufw enable

# 允许SSH
sudo ufw allow ssh

# 允许HTTP和HTTPS
sudo ufw allow 80
sudo ufw allow 443

# 只允许本地访问数据库端口
sudo ufw allow from 127.0.0.1 to any port 3306
sudo ufw allow from 127.0.0.1 to any port 6379
sudo ufw allow from 127.0.0.1 to any port 9200

# 查看防火墙状态
sudo ufw status
```

### 7.2 SSL证书配置
```bash
# 使用Let's Encrypt免费证书
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 设置自动续期
sudo crontab -e
0 12 * * * /usr/bin/certbot renew --quiet
```

## 8. 备份策略

### 8.1 数据库备份
```bash
# 创建备份脚本
nano /opt/txgy_platform/scripts/backup_database.sh
```

```bash
#!/bin/bash

BACKUP_DIR="/opt/txgy_platform/backups"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="txgy_platform"
DB_USER="txgy_user"
DB_PASSWORD="your_db_password"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 执行数据库备份
mysqldump -u $DB_USER -p$DB_PASSWORD $DB_NAME > $BACKUP_DIR/db_backup_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/db_backup_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "db_backup_*.sql.gz" -mtime +7 -delete

echo "数据库备份完成: db_backup_$DATE.sql.gz"
```

### 8.2 文件备份
```bash
# 创建文件备份脚本
nano /opt/txgy_platform/scripts/backup_files.sh
```

```bash
#!/bin/bash

BACKUP_DIR="/opt/txgy_platform/backups"
DATE=$(date +%Y%m%d_%H%M%S)
SOURCE_DIR="/opt/txgy_platform/media"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份媒体文件
tar -czf $BACKUP_DIR/media_backup_$DATE.tar.gz -C $SOURCE_DIR .

# 删除30天前的备份
find $BACKUP_DIR -name "media_backup_*.tar.gz" -mtime +30 -delete

echo "文件备份完成: media_backup_$DATE.tar.gz"
```

```bash
# 设置定时备份
crontab -e
# 每天凌晨2点备份数据库
0 2 * * * /opt/txgy_platform/scripts/backup_database.sh
# 每周日凌晨3点备份文件
0 3 * * 0 /opt/txgy_platform/scripts/backup_files.sh
```
