# 防腐保温智慧平台 - 组织架构模块设计文档（前后端分离）


## 一、文档概述

### 1.1 设计目标
构建支持用户、角色、权限、菜单、系统管理的公共组织架构模块，实现基于用户-角色-权限的颗粒化权限控制，支撑前后端分离架构下的多角色（企业用户/个人用户/平台管理员等）权限管理需求，适配系统现有技术栈与业务场景。

### 1.2 技术架构
- **前端**：Vue3 + VueRouter + Pinia + Axios + ElementPlus（基于现有技术栈扩展）
- **后端**：Python 3.12.3 + Django 5.2.5 + Django REST Framework（复用系统核心框架）
- **数据库**：MySQL 8.0+（存储核心数据） + Redis 6.0+（缓存用户权限信息）


## 二、核心模块设计

### 2.1 用户管理模块
#### 2.1.1 功能定位
管理系统所有用户（企业用户/个人用户/管理员）的基础信息、认证状态及关联角色，作为权限控制的核心载体。

#### 2.1.2 核心功能
- 用户信息CRUD（新增/编辑/查询/删除）
- 用户状态管理（启用/禁用/锁定）
- 关联角色管理（为用户分配1~N个角色）
- 密码重置/修改
- 多用户类型支持（区分企业用户/个人用户，关联对应主体信息）

#### 2.1.3 数据模型（User）
```python
# 后端模型示例（Django ORM）
class User(models.Model):
    user_id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)  # 唯一标识
    username = models.CharField(max_length=50, unique=True, verbose_name="用户名")
    password = models.CharField(max_length=128, verbose_name="加密密码")  # AES-256加密存储
    user_type = models.CharField(max_length=20, choices=[("enterprise", "企业用户"), ("individual", "个人用户"), ("admin", "管理员")], verbose_name="用户类型")
    related_id = models.UUIDField(verbose_name="关联主体ID")  # 关联企业ID/个人ID（外键）
    roles = models.ManyToManyField("Role", related_name="users", verbose_name="关联角色")
    status = models.CharField(max_length=10, choices=[("active", "启用"), ("inactive", "禁用"), ("locked", "锁定")], default="active", verbose_name="状态")
    last_login_time = models.DateTimeField(null=True, blank=True, verbose_name="最后登录时间")
    create_time = models.DateTimeField(auto_now_add=True, verbose_name="创建时间")
    update_time = models.DateTimeField(auto_now=True, verbose_name="更新时间")
```

#### 2.1.4 前端展示
- 用户列表页：支持按用户类型、状态、角色筛选，展示核心信息（用户名、类型、关联角色、状态）
- 用户详情页：展示完整信息+关联角色列表，支持编辑/角色调整
- 新增/编辑表单：区分用户类型，动态展示企业/个人关联字段


### 2.2 角色管理模块
#### 2.2.1 功能定位
作为权限的集合载体，实现“角色关联权限+用户关联角色”的间接权限分配模式，简化批量用户的权限管理。

#### 2.2.2 核心功能
- 角色信息CRUD
- 角色关联权限管理（为角色分配N个权限）
- 角色关联菜单管理（控制角色可见菜单）
- 角色关联用户查询（查看角色下的所有用户）

#### 2.2.3 数据模型（Role）
```python
class Role(models.Model):
    role_id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    role_name = models.CharField(max_length=50, unique=True, verbose_name="角色名称")  # 如“施工企业管理员”“工程甲方审核员”
    description = models.TextField(blank=True, null=True, verbose_name="角色描述")
    permissions = models.ManyToManyField("Permission", related_name="roles", verbose_name="关联权限")
    menus = models.ManyToManyField("Menu", related_name="roles", verbose_name="关联菜单")
    is_default = models.BooleanField(default=False, verbose_name="是否默认角色")  # 新用户注册时自动分配
    create_time = models.DateTimeField(auto_now_add=True, verbose_name="创建时间")
    update_time = models.DateTimeField(auto_now=True, verbose_name="更新时间")
```

#### 2.2.4 角色分类（预设）
- 平台级角色：超级管理员、系统管理员（管理组织架构核心功能）
- 企业级角色：企业管理员、企业操作员（按企业类型细分，如“生产制造企业管理员”）
- 个人级角色：施工人员、行业专家（按个人用户类型细分）


### 2.3 权限管理模块
#### 2.3.1 功能定位
实现颗粒化权限控制，将权限细化到“模块-功能-操作”三级，支持对单个接口/按钮的权限管控。

#### 2.3.2 权限粒度设计
- **模块级**：如“信息发布系统”“智能招投标平台”
- **功能级**：如“招标信息发布”“投标文件上传”
- **操作级**：如“查看”“新增”“编辑”“删除”“审核”

#### 2.3.3 核心功能
- 权限信息CRUD（支持批量导入）
- 权限分组管理（按模块/功能归类）
- 权限关联角色查询

#### 2.3.4 数据模型（Permission）
```python
class Permission(models.Model):
    perm_id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    perm_code = models.CharField(max_length=100, unique=True, verbose_name="权限标识")  # 如"bid:publish:create"（模块:功能:操作）
    perm_name = models.CharField(max_length=50, verbose_name="权限名称")  # 如“招标信息发布-新增”
    module = models.CharField(max_length=50, verbose_name="所属模块")  # 关联系统模块，如“智能招投标平台”
    function = models.CharField(max_length=50, verbose_name="所属功能")  # 如“招标信息发布”
    action = models.CharField(max_length=20, verbose_name="操作类型")  # 如“create”“view”“edit”“delete”
    is_api = models.BooleanField(default=True, verbose_name="是否接口权限")  # 区分接口权限/页面元素权限
    api_path = models.CharField(max_length=200, blank=True, null=True, verbose_name="接口路径")  # 如“/api/v1/bid/publish/”
    api_method = models.CharField(max_length=10, blank=True, null=True, verbose_name="接口方法")  # 如“POST”“GET”
    create_time = models.DateTimeField(auto_now_add=True, verbose_name="创建时间")
```

#### 2.3.5 颗粒化权限示例
| 模块               | 功能               | 操作   | 权限标识               | 适用场景                          |
|--------------------|--------------------|--------|------------------------|-----------------------------------|
| 智能招投标平台     | 招标信息发布       | 新增   | bid:publish:create     | 控制“发布招标信息”按钮是否可见    |
| 智能招投标平台     | 招标信息发布       | 查看   | bid:publish:view       | 控制“招标信息列表”接口访问权限    |
| 资源整合中心       | 供应商资质管理     | 审核   | supplier:qualify:audit | 控制“审核供应商资质”操作权限      |


### 2.4 菜单管理模块
#### 2.4.1 功能定位
管理系统前端导航菜单，通过关联权限控制不同用户可见的菜单，支持多级菜单结构。

#### 2.4.2 核心功能
- 菜单信息CRUD（支持拖拽调整排序/层级）
- 菜单关联权限管理（控制菜单可见性）
- 菜单多终端适配（电脑端/移动端菜单区分）

#### 2.4.3 数据模型（Menu）
```python
class Menu(models.Model):
    menu_id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    parent_id = models.UUIDField(null=True, blank=True, verbose_name="父菜单ID")  # 顶级菜单为null
    menu_name = models.CharField(max_length=50, verbose_name="菜单名称")
    path = models.CharField(max_length=200, verbose_name="路由路径")  # 如“/bid/publish”
    component = models.CharField(max_length=200, verbose_name="前端组件路径")  # 如“views/bid/Publish.vue”
    icon = models.CharField(max_length=50, blank=True, null=True, verbose_name="图标")  # ElementPlus图标
    sort = models.IntegerField(default=0, verbose_name="排序号")  # 越小越靠前
    terminal = models.CharField(max_length=10, choices=[("pc", "电脑端"), ("mobile", "移动端")], default="pc", verbose_name="终端类型")
    perm = models.ForeignKey("Permission", null=True, blank=True, on_delete=models.SET_NULL, related_name="menus", verbose_name="关联权限")  # 无权限关联则默认可见
    is_show = models.BooleanField(default=True, verbose_name="是否显示")
    create_time = models.DateTimeField(auto_now_add=True, verbose_name="创建时间")
    update_time = models.DateTimeField(auto_now=True, verbose_name="更新时间")
```

#### 2.4.4 菜单层级示例（电脑端）
```
- 信息交互平台（顶级菜单）
  - 招标信息管理（二级菜单，关联权限bid:manage:view）
    - 发布招标信息（三级菜单，关联权限bid:publish:create）
    - 招标列表查询（三级菜单，关联权限bid:list:view）
- 资源整合中心（顶级菜单）
  - 供应商管理（二级菜单，关联权限supplier:manage:view）
```


### 2.5 系统管理模块
#### 2.5.1 功能定位
提供系统基础配置、操作日志、数据字典等支撑功能，保障组织架构模块稳定运行。

#### 2.5.2 核心功能
- 系统参数设置：如密码有效期、登录失败锁定次数
- 操作日志管理：记录用户在组织架构模块的关键操作（符合审计日志需求，保留≥1年）
- 数据字典管理：管理用户类型、权限模块等枚举值
- 第三方登录配置：预留微信/支付宝登录接口配置（待开发）

#### 2.5.3 数据模型（OperationLog）
```python
class OperationLog(models.Model):
    log_id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    user = models.ForeignKey("User", on_delete=models.SET_NULL, null=True, related_name="logs", verbose_name="操作人")
    operation = models.CharField(max_length=100, verbose_name="操作内容")  # 如“新增角色：施工企业管理员”
    module = models.CharField(max_length=50, verbose_name="操作模块")  # 如“角色管理”
    ip_address = models.GenericIPAddressField(verbose_name="操作IP")
    operation_time = models.DateTimeField(auto_now_add=True, verbose_name="操作时间")
    operation_result = models.BooleanField(verbose_name="操作结果")  # 成功/失败
    error_msg = models.TextField(null=True, blank=True, verbose_name="错误信息")
```


## 三、权限控制流程

### 3.1 权限分配流程
1. 管理员在“权限管理”中定义颗粒化权限（如“招标信息发布-新增”）；
2. 管理员在“角色管理”中创建角色（如“工程甲方操作员”），并为角色分配权限（关联步骤1的权限）；
3. 管理员在“用户管理”中为用户分配角色（如为某工程甲方员工分配“工程甲方操作员”角色）；
4. （可选）特殊场景下，可为用户直接分配独立权限（覆盖角色权限）。

### 3.2 前端权限校验流程
1. 用户登录后，前端调用`/api/v1/auth/permissions`接口获取用户拥有的权限列表和菜单列表；
2. 前端通过Pinia存储权限标识（如`bid:publish:create`）和菜单数据；
3. 路由拦截：通过VueRouter的导航守卫，校验用户是否有访问目标路由的权限（基于菜单关联的权限）；
4. 页面元素控制：通过自定义指令（如`v-perm="['bid:publish:create']"`）控制按钮/表单的显示/禁用。

### 3.3 后端权限校验流程
1. 接口请求到达后端，Django中间件拦截请求，解析Token获取当前用户；
2. 从Redis缓存中获取用户的权限列表（若缓存失效则从数据库查询并更新缓存）；
3. 校验请求的接口路径+方法是否在用户权限列表中（匹配`Permission.api_path`和`Permission.api_method`）；
4. 校验通过则放行，否则返回403权限不足错误。


## 四、接口设计（RESTful规范）

| 模块       | 接口路径                  | 方法   | 功能描述               | 权限标识               |
|------------|---------------------------|--------|------------------------|------------------------|
| 用户管理   | `/api/v1/users`           | GET    | 查询用户列表           | user:list:view         |
| 用户管理   | `/api/v1/users`           | POST   | 新增用户               | user:create            |
| 用户管理   | `/api/v1/users/{id}`      | PUT    | 编辑用户               | user:edit              |
| 角色管理   | `/api/v1/roles`           | GET    | 查询角色列表           | role:list:view         |
| 角色管理   | `/api/v1/roles/{id}/perms`| POST   | 为角色分配权限         | role:perm:assign       |
| 权限管理   | `/api/v1/permissions`     | GET    | 查询权限列表           | perm:list:view         |
| 菜单管理   | `/api/v1/menus`           | GET    | 查询菜单列表           | menu:list:view         |
| 系统管理   | `/api/v1/logs`            | GET    | 查询操作日志           | log:list:view          |
| 认证相关   | `/api/v1/auth/permissions`| GET    | 获取当前用户权限与菜单 | -                      |


## 五、安全与性能优化

### 5.1 安全措施
- 密码存储：采用AES-256加密+盐值处理，符合系统敏感数据加密标准；
- 接口防护：所有接口启用Token验证，防SQL注入（依赖Django ORM参数化查询），防XSS（前端输入过滤）；
- 权限隔离：普通用户无法访问组织架构管理接口（通过顶级权限`system:org:manage`控制）。

### 5.2 性能优化
- 权限缓存：用户权限信息缓存至Redis，有效期1小时，减少数据库查询；
- 菜单懒加载：前端仅加载当前用户可见的菜单，减少首屏加载时间；
- 批量操作支持：提供角色批量分配用户、权限批量分配角色接口，提升管理效率。


## 六、与业务系统集成点
- 与“信息发布系统”集成：通过权限控制不同用户的信息发布/审核权限；
- 与“智能招投标平台”集成：通过角色关联招投标相关权限（如投标文件上传权限）；
- 与“用户权限管理”模块集成：复用用户认证体系，预留第三方登录扩展接口。